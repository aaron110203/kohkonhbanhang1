<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KohKong B√°n H√†ng</title>
  <link rel="stylesheet" href="styles.css">
  <script async src="https://telegram.org/js/telegram-widget.js?22"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-container">
      <div class="logo">
        <span class="logo-icon">üè™</span>
        <h1 class="logo-text">KohKong B√°n H√†ng</h1>
      </div>
      <p class="header-subtitle">H·ªá th·ªëng qu·∫£n l√Ω b√°n h√†ng tr·ª±c tuy·∫øn</p>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <div class="form-wrapper">
      <!-- LOGIN FORM -->
      <div class="form-container" id="loginContainer">
        <form class="signup-form" id="loginForm">
          <h2>ƒêƒÉng Nh·∫≠p</h2>
          <p class="form-description">Ch√†o m·ª´ng b·∫°n tr·ªü l·∫°i</p>
          
          <label>T√™n ƒêƒÉng Nh·∫≠p</label>
          <input type="text" id="login-username" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required>

          <label>M·∫≠t Kh·∫©u</label>
          <input type="password" id="login-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>

          <div class="remember-me">
            <input type="checkbox" id="remember-password">
            <label for="remember-password">Ghi nh·ªõ m·∫≠t kh·∫©u</label>
          </div>

          <button type="submit">ƒêƒÉng Nh·∫≠p</button>

          <p class="toggle-form-link">
            <a href="#" onclick="showRegisterPopup(event)">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</a>
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- REGISTER POPUP -->
  <div class="popup-overlay" id="registerPopup" style="display: none;">
    <div class="popup-container">
      <button class="popup-close" onclick="closeRegisterPopup()">&times;</button>
      <div class="popup-content">
        <form class="signup-form" id="registerForm">
          <h2>ƒêƒÉng K√Ω T√†i Kho·∫£n</h2>
          <p class="form-description">T·∫°o t√†i kho·∫£n m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu b√°n h√†ng</p>
          
          <label>T√™n ƒêƒÉng Nh·∫≠p</label>
          <input type="text" id="reg-username" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required>

          <label>H·ªç v√† T√™n</label>
          <input type="text" id="reg-fullname" placeholder="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß" required>

          <label>M·∫≠t Kh·∫©u</label>
          <input type="password" id="reg-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u (t·ªëi thi·ªÉu 6 k√Ω t·ª±)" required>

          <label>X√°c Nh·∫≠n M·∫≠t Kh·∫©u</label>
          <input type="password" id="reg-confirm-password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u" required>

          <div class="telegram-section">
            <label>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="#0088cc" style="vertical-align: middle; margin-right: 5px;">
                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161l-1.894 8.927c-.141.631-.513.784-1.039.489l-2.875-2.119-1.387 1.334c-.153.153-.281.281-.576.281l.206-2.913 5.316-4.801c.231-.206-.05-.319-.357-.113l-6.571 4.138-2.831-.887c-.616-.193-.628-.616.131-.916l11.074-4.269c.513-.193.963.119.803.849z"/>
              </svg>
              X√°c Minh Telegram (B·∫Øt bu·ªôc)
            </label>
            <p class="telegram-info">Nh·∫≠p Telegram ID ƒë·ªÉ x√°c minh t√†i kho·∫£n</p>
            
            <div class="telegram-manual">
              <div class="telegram-input-group">
                <input type="text" id="reg-telegram" placeholder="@telegram_username ho·∫∑c Telegram ID" class="telegram-input" required>
                <button type="button" class="verify-telegram-btn-small" onclick="verifyTelegram()">
                  üì≤ G·ª≠i M√£
                </button>
              </div>
              <input type="text" id="reg-telegram-code" placeholder="Nh·∫≠p m√£ 6 s·ªë t·ª´ @KohKongBanHang_bot" class="telegram-code" style="display:none;">
              <div id="reg-telegram-verified" class="telegram-verified" style="display:none;">
                ‚úÖ Telegram ƒë√£ x√°c minh
              </div>
            </div>
          </div>

          <button type="submit">ƒêƒÉng K√Ω</button>

          <p class="toggle-form-link">
            <a href="#" onclick="closeRegisterPopup()">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</a>
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 KohKong B√°n H√†ng. All rights reserved.</p>
  </footer>

  <script>
    let telegramVerified = false;
    let verifiedTelegramId = null;

    // Load saved credentials on page load
    window.addEventListener('DOMContentLoaded', function() {
      const savedUsername = localStorage.getItem('saved_username');
      const savedPassword = localStorage.getItem('saved_password');
      
      if (savedUsername && savedPassword) {
        document.getElementById('login-username').value = savedUsername;
        document.getElementById('login-password').value = savedPassword;
        document.getElementById('remember-password').checked = true;
      }
    });

    // Show Register Popup
    function showRegisterPopup(event) {
      event.preventDefault();
      document.getElementById('registerPopup').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    // Close Register Popup
    function closeRegisterPopup() {
      document.getElementById('registerPopup').style.display = 'none';
      document.body.style.overflow = 'auto';
      document.getElementById('registerForm').reset();
      telegramVerified = false;
      document.getElementById('reg-telegram-code').style.display = 'none';
      document.getElementById('reg-telegram-verified').style.display = 'none';
    }

    // Close popup when clicking outside
    document.getElementById('registerPopup').addEventListener('click', function(e) {
      if (e.target === this) {
        closeRegisterPopup();
      }
    });

    // Verify Telegram
    async function verifyTelegram() {
      const telegramInput = document.getElementById('reg-telegram').value;
      
      if (!telegramInput) {
        alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p Telegram username ho·∫∑c ID!');
        return;
      }

      try {
        const response = await fetch('http://localhost:3000/api/send-verification', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({telegram: telegramInput})
        });
        
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('reg-telegram-code').style.display = 'block';
          alert('‚úÖ ' + data.message + '\n\nKi·ªÉm tra @KohKongBanHang_bot v√† nh·∫≠p m√£ v√†o √¥ b√™n d∆∞·ªõi.');
        } else {
          alert('‚ùå L·ªói: ' + data.error + '\n\nüí° H∆∞·ªõng d·∫´n:\n1. M·ªü Telegram, t√¨m @KohKongBanHang_bot\n2. G·ª≠i /start cho bot\n3. Nh·∫≠p ƒë√∫ng username (VD: @yourname) ho·∫∑c ID s·ªë');
        }
      } catch (error) {
        alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi server!\n\nVui l√≤ng ƒë·∫£m b·∫£o server ƒëang ch·∫°y.');
        console.error('Error:', error);
      }
    }

    // Handle Login Form Submit
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      const rememberPassword = document.getElementById('remember-password').checked;
      
      try {
        const loginResponse = await fetch('http://localhost:3000/api/login', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            username: username,
            password: password
          })
        });
        
        const loginData = await loginResponse.json();
        
        if (loginData.success) {
          // Save credentials if remember is checked
          if (rememberPassword) {
            localStorage.setItem('saved_username', username);
            localStorage.setItem('saved_password', password);
          } else {
            localStorage.removeItem('saved_username');
            localStorage.removeItem('saved_password');
          }
          
          alert('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!\n\nCh√†o m·ª´ng ' + loginData.user.fullname);
          // Redirect to dashboard
          // window.location.href = '/dashboard.html';
        } else {
          alert('‚ùå ' + loginData.error);
        }
      } catch (error) {
        alert('‚ùå L·ªói k·∫øt n·ªëi server!');
        console.error('Error:', error);
      }
    });

    // Handle Register Form Submit
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const username = document.getElementById('reg-username').value;
      const fullname = document.getElementById('reg-fullname').value;
      const password = document.getElementById('reg-password').value;
      const confirmPassword = document.getElementById('reg-confirm-password').value;
      const telegramInput = document.getElementById('reg-telegram').value;
      const telegramCode = document.getElementById('reg-telegram-code').value;
      
      // Validate
      if (password !== confirmPassword) {
        alert('‚ùå M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
        return;
      }
      
      if (password.length < 6) {
        alert('‚ùå M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
        return;
      }
      
      if (!telegramCode) {
        alert('‚ö†Ô∏è Vui l√≤ng x√°c minh Telegram tr∆∞·ªõc khi ƒëƒÉng k√Ω!');
        return;
      }
      
      try {
        // Verify Telegram code first
        const verifyResponse = await fetch('http://localhost:3000/api/verify-code', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            telegram: telegramInput,
            code: telegramCode
          })
        });
        
        const verifyData = await verifyResponse.json();
        
        if (!verifyData.success) {
          alert('‚ùå ' + verifyData.error);
          return;
        }
        
        // Show verification success
        document.getElementById('reg-telegram-verified').style.display = 'block';
        document.getElementById('reg-telegram-code').style.display = 'none';
        verifiedTelegramId = verifyData.telegram_id;
        
        // Register user
        const registerResponse = await fetch('http://localhost:3000/api/register', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            username: username,
            fullname: fullname,
            password: password,
            telegram_id: verifiedTelegramId
          })
        });
        
        const registerData = await registerResponse.json();
        
        if (registerData.success) {
          alert('üéâ ƒêƒÉng k√Ω th√†nh c√¥ng!\n\nT√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o.\nB·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p ngay b√¢y gi·ªù.');
          closeRegisterPopup();
          
          // Auto fill login form
          document.getElementById('login-username').value = username;
          document.getElementById('login-password').value = password;
        } else {
          alert('‚ùå ' + registerData.error);
        }
      } catch (error) {
        alert('‚ùå L·ªói k·∫øt n·ªëi server!');
        console.error('Error:', error);
      }
    });
  </script>
</body>
</html>
