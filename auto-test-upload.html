<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AUTO TEST - Upload ·∫¢nh T·ª± ƒê·ªông</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .test-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
    }
    .test-section h2 {
      color: #667eea;
      margin-bottom: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.1rem;
      margin: 10px 5px;
      transition: transform 0.2s;
    }
    button:hover { transform: scale(1.05); }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.8;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .success { color: #4ec9b0; }
    .error { color: #f48771; }
    .warning { color: #dcdcaa; }
    .info { color: #9cdcfe; }
    .preview-box {
      margin-top: 20px;
      padding: 20px;
      background: white;
      border-radius: 10px;
      border: 3px solid #667eea;
    }
    .preview-box img {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid #667eea;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
    }
    .stat-label {
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñ AUTO TEST - Upload ·∫¢nh T·ª± ƒê·ªông</h1>
    
    <div class="test-section">
      <h2>üìä Test Dashboard</h2>
      <button onclick="runFullTest()">üöÄ Ch·∫°y Test ƒê·∫ßy ƒê·ªß (ƒêƒÉng K√Ω + ƒêƒÉng Nh·∫≠p + Upload)</button>
      <button onclick="testUploadOnly()">üì∏ Test Ch·ªâ Upload ·∫¢nh</button>
      <button onclick="checkCurrentState()">üîç Ki·ªÉm Tra Tr·∫°ng Th√°i</button>
      <button onclick="clearAllData()" style="background: #f48771;">üóëÔ∏è X√≥a D·ªØ Li·ªáu</button>
      
      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-value" id="stat-users">0</div>
          <div class="stat-label">S·ªë ƒê·∫°i L√Ω</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-products">0</div>
          <div class="stat-label">T·ªïng S·∫£n Ph·∫©m</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-storage">0 KB</div>
          <div class="stat-label">B·ªô Nh·ªõ D√πng</div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h2>üìù Log K·∫øt Qu·∫£</h2>
      <div class="log" id="log"></div>
    </div>

    <div class="test-section" id="preview-section" style="display: none;">
      <h2>üëÅÔ∏è Preview S·∫£n Ph·∫©m V·ª´a T·∫°o</h2>
      <div class="preview-box" id="preview-box"></div>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('vi-VN');
      const color = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
      logEl.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStats() {
      const agents = JSON.parse(localStorage.getItem('agents')) || [];
      let totalProducts = 0;
      agents.forEach(a => {
        if (a.products) totalProducts += a.products.length;
      });
      
      let storageSize = 0;
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          storageSize += localStorage.getItem(key).length;
        }
      }
      
      document.getElementById('stat-users').textContent = agents.length;
      document.getElementById('stat-products').textContent = totalProducts;
      document.getElementById('stat-storage').textContent = (storageSize / 1024).toFixed(2) + ' KB';
    }

    // T·∫°o ·∫£nh test (·∫£nh customer service nh∆∞ b·∫°n g·ª≠i)
    function createTestImage() {
      // Base64 c·ªßa 1 ·∫£nh nh·ªè m·∫´u (200x200px)
      return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
    }

    async function runFullTest() {
      log('üöÄ B·∫ÆT ƒê·∫¶U TEST ƒê·∫¶Y ƒê·ª¶...', 'warning');
      log('‚îÅ'.repeat(50), 'info');
      
      try {
        // 1. T·∫°o t√†i kho·∫£n test
        log('1Ô∏è‚É£ B∆Ø·ªöC 1: ƒêƒÉng k√Ω t√†i kho·∫£n test...', 'info');
        const testUser = {
          id: 'auto_' + Date.now(),
          fullname: 'Auto Test User',
          username: 'autotest_' + Date.now(),
          password: '123456',
          telegram: '@autotest',
          role: 'agent',
          products: [],
          isActive: true,
          createdAt: new Date().toISOString()
        };
        
        let agents = JSON.parse(localStorage.getItem('agents')) || [];
        agents.push(testUser);
        localStorage.setItem('agents', JSON.stringify(agents));
        log('‚úÖ ƒê√£ t·∫°o user: ' + testUser.username, 'success');
        
        // 2. ƒêƒÉng nh·∫≠p
        log('2Ô∏è‚É£ B∆Ø·ªöC 2: ƒêƒÉng nh·∫≠p...', 'info');
        localStorage.setItem('currentUser', JSON.stringify(testUser));
        log('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
        
        // 3. Upload ·∫£nh
        log('3Ô∏è‚É£ B∆Ø·ªöC 3: Upload ·∫£nh s·∫£n ph·∫©m...', 'info');
        const imageBase64 = createTestImage();
        log('üì∏ ƒê√£ t·∫°o ·∫£nh test (Base64): ' + imageBase64.substring(0, 50) + '...', 'info');
        
        // 4. T·∫°o s·∫£n ph·∫©m
        log('4Ô∏è‚É£ B∆Ø·ªöC 4: T·∫°o s·∫£n ph·∫©m v·ªõi ·∫£nh...', 'info');
        const product = {
          id: 'product_' + Date.now(),
          name: 'S·∫£n Ph·∫©m Auto Test',
          price: 50000,
          category: 'food',
          icon: 'üçö',
          description: 'ƒê√¢y l√† s·∫£n ph·∫©m ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·ªüi Auto Test',
          telegram: testUser.telegram,
          imageUrl: imageBase64, // ‚úÖ QUAN TR·ªåNG: ·∫¢nh ƒë∆∞·ª£c l∆∞u ·ªü ƒë√¢y!
          agentId: testUser.id,
          agentName: testUser.fullname,
          agentTelegram: testUser.telegram,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // 5. Th√™m s·∫£n ph·∫©m v√†o agent
        agents = JSON.parse(localStorage.getItem('agents')) || [];
        const agentIndex = agents.findIndex(a => a.username === testUser.username);
        
        if (agentIndex === -1) {
          throw new Error('Kh√¥ng t√¨m th·∫•y agent!');
        }
        
        if (!agents[agentIndex].products) {
          agents[agentIndex].products = [];
        }
        
        agents[agentIndex].products.push(product);
        localStorage.setItem('agents', JSON.stringify(agents));
        
        log('‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m th√†nh c√¥ng!', 'success');
        log('üì¶ ID: ' + product.id, 'info');
        log('üìù T√™n: ' + product.name, 'info');
        log('üí∞ Gi√°: ' + product.price.toLocaleString('vi-VN') + ' ‚Ç≠', 'info');
        log('üì∏ C√≥ ·∫£nh: ' + (product.imageUrl ? 'C√ì (' + (product.imageUrl.length / 1024).toFixed(2) + ' KB)' : 'KH√îNG'), product.imageUrl ? 'success' : 'error');
        
        // 6. Hi·ªÉn th·ªã preview
        log('5Ô∏è‚É£ B∆Ø·ªöC 5: Hi·ªÉn th·ªã preview...', 'info');
        showPreview(product);
        
        log('‚îÅ'.repeat(50), 'info');
        log('üéâ TEST HO√ÄN T·∫§T TH√ÄNH C√îNG!', 'success');
        log('', 'info');
        log('üìã KI·ªÇM TRA K·∫æT QU·∫¢:', 'warning');
        log('1. M·ªü products.html ƒë·ªÉ xem s·∫£n ph·∫©m', 'info');
        log('2. M·ªü dashboard.html ƒë·ªÉ qu·∫£n l√Ω', 'info');
        log('3. ·∫¢nh ƒë√£ ƒë∆∞·ª£c l∆∞u d∆∞·ªõi d·∫°ng Base64', 'info');
        
        updateStats();
        
      } catch (error) {
        log('‚ùå L·ªñI: ' + error.message, 'error');
        console.error(error);
      }
    }

    function testUploadOnly() {
      log('üì∏ TEST CH·ª®C NƒÇNG UPLOAD ·∫¢NH...', 'warning');
      
      try {
        const currentUserStr = localStorage.getItem('currentUser');
        if (!currentUserStr) {
          log('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p! H√£y ch·∫°y "Test ƒê·∫ßy ƒê·ªß" tr∆∞·ªõc.', 'error');
          return;
        }
        
        const currentUser = JSON.parse(currentUserStr);
        log('‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p: ' + currentUser.username, 'success');
        
        // T·∫°o ·∫£nh test
        const imageBase64 = createTestImage();
        log('üì∏ T·∫°o ·∫£nh test...', 'info');
        log('üìè K√≠ch th∆∞·ªõc Base64: ' + (imageBase64.length / 1024).toFixed(2) + ' KB', 'info');
        
        // T·∫°o s·∫£n ph·∫©m m·ªõi
        const product = {
          id: 'product_' + Date.now(),
          name: 'Test Upload ' + new Date().getHours() + ':' + new Date().getMinutes(),
          price: 25000,
          category: 'food',
          icon: 'üì¶',
          description: 'Test upload ·∫£nh',
          telegram: currentUser.telegram,
          imageUrl: imageBase64,
          agentId: currentUser.id,
          agentName: currentUser.fullname,
          agentTelegram: currentUser.telegram,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // L∆∞u v√†o localStorage
        const agents = JSON.parse(localStorage.getItem('agents')) || [];
        const agentIndex = agents.findIndex(a => a.username === currentUser.username);
        
        if (agentIndex !== -1) {
          if (!agents[agentIndex].products) {
            agents[agentIndex].products = [];
          }
          agents[agentIndex].products.push(product);
          localStorage.setItem('agents', JSON.stringify(agents));
          
          log('‚úÖ Upload ·∫£nh th√†nh c√¥ng!', 'success');
          log('üì¶ S·∫£n ph·∫©m: ' + product.name, 'info');
          log('üì∏ ·∫¢nh ƒë√£ l∆∞u: ' + (imageBase64.length / 1024).toFixed(2) + ' KB', 'success');
          
          showPreview(product);
          updateStats();
        } else {
          log('‚ùå Kh√¥ng t√¨m th·∫•y agent!', 'error');
        }
        
      } catch (error) {
        log('‚ùå L·ªñI: ' + error.message, 'error');
      }
    }

    function checkCurrentState() {
      log('üîç KI·ªÇM TRA TR·∫†NG TH√ÅI H·ªÜ TH·ªêNG...', 'warning');
      log('‚îÅ'.repeat(50), 'info');
      
      // Check login
      const currentUser = localStorage.getItem('currentUser');
      if (currentUser) {
        const user = JSON.parse(currentUser);
        log('‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p: ' + user.username + ' (' + user.fullname + ')', 'success');
      } else {
        log('‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p', 'warning');
      }
      
      // Check agents
      const agents = JSON.parse(localStorage.getItem('agents')) || [];
      log('üë• T·ªïng s·ªë ƒë·∫°i l√Ω: ' + agents.length, 'info');
      
      let totalProducts = 0;
      let productsWithImages = 0;
      
      agents.forEach(agent => {
        if (agent.products) {
          totalProducts += agent.products.length;
          agent.products.forEach(p => {
            if (p.imageUrl) productsWithImages++;
          });
        }
      });
      
      log('üì¶ T·ªïng s·∫£n ph·∫©m: ' + totalProducts, 'info');
      log('üì∏ S·∫£n ph·∫©m c√≥ ·∫£nh: ' + productsWithImages + '/' + totalProducts, productsWithImages > 0 ? 'success' : 'warning');
      
      // Storage usage
      let storageSize = 0;
      for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
          storageSize += localStorage.getItem(key).length;
        }
      }
      log('üíæ B·ªô nh·ªõ: ' + (storageSize / 1024).toFixed(2) + ' KB', 'info');
      
      log('‚îÅ'.repeat(50), 'info');
      
      updateStats();
    }

    function showPreview(product) {
      const previewSection = document.getElementById('preview-section');
      const previewBox = document.getElementById('preview-box');
      
      previewSection.style.display = 'block';
      previewBox.innerHTML = `
        <h3 style="color: #333; margin-bottom: 15px;">üì¶ ${product.name}</h3>
        <p style="color: #666; margin-bottom: 10px;">üí∞ Gi√°: <strong>${product.price.toLocaleString('vi-VN')} ‚Ç≠</strong></p>
        <p style="color: #666; margin-bottom: 10px;">üì± Telegram: <strong>${product.telegram}</strong></p>
        <p style="color: #666; margin-bottom: 10px;">üìù M√¥ t·∫£: ${product.description}</p>
        ${product.imageUrl ? `
          <div style="margin-top: 20px;">
            <p style="color: #28a745; font-weight: bold; margin-bottom: 10px;">‚úÖ C√≥ ·∫£nh (${(product.imageUrl.length / 1024).toFixed(2)} KB)</p>
            <img src="${product.imageUrl}" alt="${product.name}" style="max-width: 300px; border-radius: 10px; border: 2px solid #667eea;">
          </div>
        ` : '<p style="color: #f48771; font-weight: bold;">‚ùå Kh√¥ng c√≥ ·∫£nh</p>'}
      `;
      
      previewSection.scrollIntoView({ behavior: 'smooth' });
    }

    function clearAllData() {
      if (confirm('‚ö†Ô∏è X√≥a t·∫•t c·∫£ d·ªØ li·ªáu test?')) {
        localStorage.clear();
        sessionStorage.clear();
        log('üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!', 'warning');
        updateStats();
        document.getElementById('preview-section').style.display = 'none';
      }
    }

    // Auto check on load
    window.addEventListener('load', function() {
      log('ü§ñ Auto Test System v1.0', 'success');
      log('‚îÅ'.repeat(50), 'info');
      checkCurrentState();
    });
  </script>
</body>
</html>
